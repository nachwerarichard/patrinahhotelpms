
<html>
  <head>
        <script src="https://cdn.tailwindcss.com"></script>

  </head>
<body>
<div class="p-8 bg-gray-50 min-h-screen font-sans">
  <div class="max-w-4xl mx-auto space-y-8">
    
    <section class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
      <h2 class="text-xl font-bold text-gray-800 mb-4">1. Define Room Type & Default Rate</h2>
      <form id="typeForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <input type="text" id="typeName" placeholder="Type (e.g. Suite)" class="p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
        <input type="number" id="basePrice" placeholder="Base Price ($)" class="p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
        <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Save Type</button>
      </form>
    </section>

    <section class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
      <h2 class="text-xl font-bold text-gray-800 mb-4">2. Set Seasonal Pricing</h2>
      <form id="seasonForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <select id="targetType" class="p-2 border rounded-lg"></select>
        <input type="text" id="seasonName" placeholder="Season (e.g. Summer)" class="p-2 border rounded-lg">
        <input type="date" id="startDate" class="p-2 border rounded-lg text-sm">
        <input type="date" id="endDate" class="p-2 border rounded-lg text-sm">
        <input type="number" id="seasonRate" placeholder="Seasonal Price ($)" class="p-2 border rounded-lg col-span-full md:col-span-1">
        <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition col-span-full">Apply Seasonal Rate</button>
      </form>
    </section>

    <section class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
  <h2 class="text-xl font-bold text-gray-800 mb-4">Add Physical Room</h2>
  <form id="roomForm" class="flex flex-col md:flex-row gap-4">
    <input type="text" id="roomNumber" placeholder="Room # (e.g. 101)" 
           class="p-2 border border-gray-300 rounded-lg flex-1 outline-none focus:ring-2 focus:ring-green-500">
    
    <select id="roomTypeSelect" class="p-2 border border-gray-300 rounded-lg flex-1 outline-none">
      <option value="">Select Room Type...</option>
    </select>
    
    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">
      Add Room
    </button>
  </form>
</section>
    <section class="bg-white p-6 rounded-xl shadow-md border border-gray-200 mt-8">
  <h2 class="text-xl font-bold text-gray-800 mb-4">Manage Rooms</h2>
  <div class="overflow-x-auto">
    <table class="min-w-full table-auto">
      <thead class="bg-gray-100">
        <tr>
          <th class="px-4 py-2 text-left">Room #</th>
          <th class="px-4 py-2 text-left">Type</th>
          <th class="px-4 py-2 text-left">Base Price</th>
          <th class="px-4 py-2 text-left">Status</th>
          <th class="px-4 py-2 text-center">Actions</th>
        </tr>
      </thead>
      <tbody id="roomTableBody">
        </tbody>
    </table>
  </div>
</section>

    <div id="editModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Edit Room Details</h2>
        
        <form id="editRoomForm" class="space-y-4">
            <input type="hidden" id="editRoomId">
            <input type="hidden" id="editTypeId">

            <div>
                <label class="block text-sm font-medium text-gray-700">Room Number</label>
                <input type="text" id="editRoomNumber" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Room Type Name</label>
                <input type="text" id="editTypeName" class="w-full p-2 border rounded-lg bg-gray-50 outline-none" readonly>
                <p class="text-xs text-gray-500 mt-1">Type name is managed in Type Settings.</p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Base Price ($)</label>
                <input type="number" id="editBasePrice" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
            </div>

            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium">Cancel</button>
                <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition">Save Changes</button>
            </div>
        </form>
    </div>
</div>
  </div>
</div>

<script>
                  const BASE_URL = 'https://patrinahhotelpms.onrender.com';

  // --- Logic for defining Room Types ---
// Ensure BASE_URL is defined at the top of your script

document.getElementById('typeForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        name: document.getElementById('typeName').value,
        basePrice: document.getElementById('basePrice').value
    };
    
    // Note the backticks below!
    try {
        const res = await fetch(`${BASE_URL}/api/room-types`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if(res.ok) {
            alert("Room Type Created!");
            loadRoomTypes(); // Refresh your dropdowns
        } else {
            console.error("Server responded with an error");
        }
    } catch (error) {
        console.error("Failed to connect to the server:", error);
    }
});

// --- Logic for Seasonal Rates ---
document.getElementById('seasonForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const typeId = document.getElementById('targetType').value;
    const data = {
        seasonName: document.getElementById('seasonName').value,
        startDate: document.getElementById('startDate').value,
        endDate: document.getElementById('endDate').value,
        rate: document.getElementById('seasonRate').value
    };

    const res = await fetch(`${BASE_URL}/api/room-types/${typeId}/seasons`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    if(res.ok) alert("Season Applied!");
});

// Function to handle adding a room
document.getElementById('roomForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const roomNumber = document.getElementById('roomNumber').value;
    const roomTypeId = document.getElementById('roomTypeSelect').value;

    // Client-side validation
    if (!roomTypeId) {
        alert("Please select a Room Type from the dropdown first.");
        return;
    }

    const roomData = {
        number: roomNumber,
        roomTypeId: roomTypeId 
    };

    try {
        const res = await fetch(`${BASE_URL}/api/rooms`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(roomData)
        });

        const result = await res.json();

        if (res.ok) {
            alert("Room added successfully!");
            e.target.reset();
        } else {
            alert("Error: " + (result.error || "Failed to save room"));
        }
    } catch (err) {
        alert("Network error: Could not connect to server.");
    }
});

  // Add this to your existing <script> block
async function loadRoomTypes() {
    try {
        const response = await fetch(`${BASE_URL}/api/room-types`);
        if (!response.ok) throw new Error('Failed to fetch types');
        
        const types = await response.json();
        
        // Target both dropdown IDs
        const seasonSelect = document.getElementById('targetType');
        const roomSelect = document.getElementById('roomTypeSelect');

        // Create the HTML options
        const optionsHTML = types.map(t => 
            `<option value="${t._id}">${t.name} (Base: $${t.basePrice})</option>`
        ).join('');

        // Inject into dropdowns
        if (seasonSelect) seasonSelect.innerHTML = `<option value="">Select Room Type...</option>` + optionsHTML;
        if (roomSelect) roomSelect.innerHTML = `<option value="">Select Room Type...</option>` + optionsHTML;
        
        console.log("Dropdowns updated with", types.length, "types");
    } catch (error) {
        console.error("Error loading dropdowns:", error);
    }
}

  async function fetchRooms() {
    try {
        const res = await fetch(`${BASE_URL}/api/rooms`);
        const rooms = await res.json();
        const tbody = document.getElementById('roomTableBody');
        
        tbody.innerHTML = rooms.map(room => `
            <tr class="border-b hover:bg-gray-50">
                <td class="px-4 py-3 font-medium">${room.number}</td>
                <td class="px-4 py-3">${room.roomTypeId ? room.roomTypeId.name : 'N/A'}</td>
                <td class="px-4 py-3">$${room.roomTypeId ? room.roomTypeId.basePrice : 0}</td>
                <td class="px-4 py-3">
                    <span class="px-2 py-1 rounded text-xs ${room.status === 'clean' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
                        ${room.status}
                    </span>
                </td>
                // Inside your fetchRooms() function's .map()
<td class="px-4 py-3 text-center space-x-2">
    <button 
        onclick="editRoom('${room._id}')" 
        class="bg-blue-100 text-blue-600 px-3 py-1 rounded-md hover:bg-blue-200 transition font-medium"
    >
        Edit
    </button>
    <button 
        onclick="deleteRoom('${room._id}')" 
        class="bg-red-100 text-red-600 px-3 py-1 rounded-md hover:bg-red-200 transition font-medium"
    >
        Delete
    </button>
</td>
        `).join('');
    } catch (err) {
        console.error("Error fetching rooms:", err);
    }
}

async function deleteRoom(id) {
    if (!confirm("Are you sure you want to delete this room?")) return;
    
    const res = await fetch(`${BASE_URL}/api/rooms/${id}`, { method: 'DELETE' });
    if (res.ok) {
        alert("Room deleted!");
        fetchRooms(); // Refresh the table
    }
}

// Function to open modal and fill data
async function editRoom(roomId) {
    try {
        // 1. Fetch current room details (populated with type)
        const res = await fetch(`${BASE_URL}/api/rooms`);
        const rooms = await res.json();
        const room = rooms.find(r => r._id === roomId);

        if (!room) return alert("Room not found");

        // 2. Fill the form
        document.getElementById('editRoomId').value = room._id;
        document.getElementById('editTypeId').value = room.roomTypeId._id;
        document.getElementById('editRoomNumber').value = room.number;
        document.getElementById('editTypeName').value = room.roomTypeId.name;
        document.getElementById('editBasePrice').value = room.roomTypeId.basePrice;

        // 3. Show Modal
        const modal = document.getElementById('editModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    } catch (err) {
        console.error("Error opening modal:", err);
    }
}

function closeModal() {
    const modal = document.getElementById('editModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}

// Handle Modal Submission
document.getElementById('editRoomForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const roomId = document.getElementById('editRoomId').value;
    const typeId = document.getElementById('editTypeId').value;
    
    const updatedRoomNumber = document.getElementById('editRoomNumber').value;
    const updatedPrice = document.getElementById('editBasePrice').value;

    try {
        // Update Room Number
        const roomRes = await fetch(`${BASE_URL}/api/rooms/${roomId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ number: updatedRoomNumber })
        });

        // Update Room Type Price (Updates all rooms of this type)
        const typeRes = await fetch(`${BASE_URL}/api/room-types/${typeId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ basePrice: updatedPrice })
        });

        if (roomRes.ok && typeRes.ok) {
            alert("Updated successfully!");
            closeModal();
            fetchRooms(); // Refresh the table
        }
    } catch (err) {
        alert("Update failed: " + err.message);
    }
});

// 2. Close Modal
function closeModal() {
    document.getElementById('editModal').classList.add('hidden');
}

// 3. Handle Form Submission
document.getElementById('editRoomForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const id = document.getElementById('editRoomId').value;
    const updatedData = {
        number: document.getElementById('editRoomNumber').value,
        status: document.getElementById('editRoomStatus').value
    };

    try {
        const res = await fetch(`${BASE_URL}/api/rooms/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedData)
        });

        if (res.ok) {
            closeModal();
            fetchRooms(); // Refresh the table
        } else {
            const err = await res.json();
            alert("Update failed: " + err.error);
        }
    } catch (error) {
        console.error("Error updating room:", error);
    }
});
  
// Ensure rooms load when page opens
window.addEventListener('DOMContentLoaded', () => {
    loadRoomTypes();
    fetchRooms();
});

// CRITICAL: Call this function as soon as the page loads!
window.onload = loadRoomTypes;
  
</script>
  </body>
</html>
