<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel POS System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl overflow-hidden p-6 md:p-8 transition-all duration-300">

        <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-6">Hotel Point of Sale</h1>
        
        <div id="messageBox" class="min-h-[2rem] text-center font-medium my-4"></div>

        <!-- Search Existing Transaction -->
        <div id="searchAccountSection">
            <h2 class="text-2xl font-semibold text-center text-gray-700 mb-4">Find Existing Transaction</h2>
            <form id="searchAccountForm" class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 mb-4">
                <input type="text" id="searchQuery" name="searchQuery" required placeholder="Guest name or Room number" class="flex-1 px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:ring-purple-500 focus:border-purple-500 transition-colors duration-200">
                <button type="submit" class="px-6 py-3 bg-purple-600 text-white font-semibold rounded-xl shadow-lg hover:bg-purple-700 transition-colors duration-200">Search</button>
            </form>
            <div id="searchResults" class="space-y-2"></div>
        </div>

        <!-- Create New Transaction -->
        <div id="createAccountSection">
            <h2 class="text-2xl font-semibold text-center text-gray-700 mb-4">Start New Transaction</h2>
            <form id="createAccountForm" class="space-y-4">
                <div>
                    <label for="guestName" class="block text-sm font-medium text-gray-700">Guest Name</label>
                    <input type="text" id="guestName" name="guestName" required placeholder="e.g., John Doe" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
                </div>
                <div>
                    <label for="roomNumber" class="block text-sm font-medium text-gray-700">Room Number (Optional)</label>
                    <input type="text" id="roomNumber" name="roomNumber" placeholder="e.g., 101" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
                </div>
                <button type="submit" class="w-full px-6 py-3 bg-blue-600 text-white font-semibold rounded-xl shadow-lg hover:bg-blue-700 transition-colors duration-200">Create Account</button>
            </form>
        </div>

        <hr class="my-8">

        <!-- Active Account Section -->
        <div id="activeAccountSection" class="hidden">
            <h2 class="text-2xl font-semibold text-center text-gray-700 mb-4">Active Transaction</h2>
            <div class="bg-blue-50 border border-blue-200 text-blue-800 p-4 rounded-xl shadow-inner mb-6">
                <p class="font-medium text-lg">Guest: <span id="currentGuestName" class="font-bold"></span></p>
                <p class="text-sm">Room: <span id="currentRoomNumber"></span></p>
                <div class="flex justify-between items-center mt-2 pt-2 border-t border-blue-200">
                    <span class="font-bold text-xl">Total Due:</span>
                    <span class="font-bold text-xl text-blue-600">$<span id="totalCharges">0.00</span></span>
                </div>
            </div>

            <!-- Add Charge -->
            <form id="addChargeForm" class="space-y-4 mb-6">
                <h3 class="text-xl font-medium text-gray-700">Add a New Charge</h3>
                <div>
                    <label for="chargeDescription" class="block text-sm font-medium text-gray-700">Description</label>
                    <input type="text" id="chargeDescription" name="description" required placeholder="e.g., 2 Beers" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
                </div>
                <div>
                    <label for="chargeAmount" class="block text-sm font-medium text-gray-700">Amount</label>
                    <input type="number" id="chargeAmount" name="amount" required step="0.01" min="0" placeholder="e.g., 15.50" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
                </div>
                <button type="submit" class="w-full px-6 py-3 bg-green-500 text-white font-semibold rounded-xl shadow-lg hover:bg-green-600 transition-colors duration-200">Add Charge</button>
            </form>

            <hr class="my-8">

            <!-- Settle Account -->
            <div id="settleAccountSection">
                <h3 class="text-xl font-semibold text-center text-gray-700 mb-4">Settle Account</h3>
                <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                    <button id="postToRoomBtn" class="flex-1 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl shadow-lg hover:bg-indigo-700 transition-colors duration-200">Post to Room</button>
                    <button id="issueReceiptBtn" class="flex-1 px-6 py-3 bg-red-500 text-white font-semibold rounded-xl shadow-lg hover:bg-red-600 transition-colors duration-200">Issue Receipt</button>
                </div>
            </div>
        </div>
    </div>
    <div id="reportsSection" class="mt-8">
            <h2 class="text-2xl font-semibold text-center text-gray-700 mb-4">Daily Reports</h2>
            <form id="dailyReportForm" class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 mb-4">
                <input type="date" id="reportDate" required class="flex-1 px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:ring-purple-500 focus:border-purple-500 transition-colors duration-200">
                <button type="submit" class="px-6 py-3 bg-purple-600 text-white font-semibold rounded-xl shadow-lg hover:bg-purple-700 transition-colors duration-200">View Report</button>
            </form>
            <div id="reportResults" class="hidden">
                <div class="bg-purple-50 border border-purple-200 text-purple-800 p-4 rounded-xl shadow-inner mb-4">
                    <p class="font-medium text-lg">Total Revenue for <span id="reportDateDisplay" class="font-bold"></span>:</p>
                    <p class="font-bold text-xl text-purple-600">$<span id="reportTotalRevenue">0.00</span></p>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-xl shadow-sm">
                        <thead>
                            <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Guest / Room</th>
                                <th class="py-3 px-6 text-left">Description</th>
                                <th class="py-3 px-6 text-center">Source</th>
                                <th class="py-3 px-6 text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody" class="text-gray-600 text-sm font-light"></tbody>
                    </table>
                </div>
                <button id="exportReportBtn" class="w-full mt-4 px-6 py-3 bg-green-600 text-white font-semibold rounded-xl shadow-lg hover:bg-green-700 transition-colors duration-200">Export to Excel</button>
            </div>
        </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const BASE_URL = 'https://patrinahhotelpms.onrender.com';
        
        const messageBox = document.getElementById('messageBox');
        const createAccountSection = document.getElementById('createAccountSection');
        const createAccountForm = document.getElementById('createAccountForm');
        const searchAccountSection = document.getElementById('searchAccountSection');
        const searchAccountForm = document.getElementById('searchAccountForm');
        const searchResults = document.getElementById('searchResults');
        const activeAccountSection = document.getElementById('activeAccountSection');
        const addChargeForm = document.getElementById('addChargeForm');
        const postToRoomBtn = document.getElementById('postToRoomBtn');
        const issueReceiptBtn = document.getElementById('issueReceiptBtn');

        let activeAccountId = null;
        let activeAccountData = null;

        const displayMessage = (message, type) => {
            messageBox.textContent = message;
            messageBox.className = 'min-h-[2rem] text-center font-medium my-4';
            if (type === 'success') messageBox.classList.add('text-green-600');
            if (type === 'error') messageBox.classList.add('text-red-600');
            if (type === 'info') messageBox.classList.add('text-blue-600');
        };

        const generateReceiptHtml = (account) => {
            const today = new Date();
            const date = today.toLocaleDateString();
            const time = today.toLocaleTimeString();
            const chargesList = (account.charges || []).map(c => `
                <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px dotted #ccc;">
                    <span>${c.description}</span>
                    <span>$${c.amount.toFixed(2)}</span>
                </div>
            `).join('');
            return `
                <html><head><title>Receipt</title></head>
                <body style="font-family:Inter,sans-serif;padding:20px;font-size:14px;">
                    <div style="width:300px;margin:auto;border:1px solid #000;padding:20px;">
                        <h2 style="text-align:center;">Patrinah Hotel</h2>
                        <p style="text-align:center;">123 Hotel Street, City</p>
                        <hr>
                        <p><b>Guest:</b> ${account.guestName}</p>
                        <p><b>Room:</b> ${account.roomNumber || 'N/A'}</p>
                        <p><b>Date:</b> ${date}</p>
                        <p><b>Time:</b> ${time}</p>
                        <hr>
                        ${chargesList}
                        <hr>
                        <p style="display:flex;justify-content:space-between;"><b>Total:</b> $${account.totalCharges.toFixed(2)}</p>
                        <p style="text-align:center;">Thank you for your business!</p>
                    </div>
                </body></html>
            `;
        };

        const updateActiveAccountUI = (account) => {
            document.getElementById('currentGuestName').textContent = account.guestName;
            document.getElementById('currentRoomNumber').textContent = account.roomNumber || 'Walk-In Guest';
            document.getElementById('totalCharges').textContent = account.totalCharges?.toFixed(2) || '0.00';
            postToRoomBtn.classList.toggle('hidden', !account.roomNumber);
            createAccountSection.classList.add('hidden');
            searchAccountSection.classList.add('hidden');
            activeAccountSection.classList.remove('hidden');
        };

        const resetUI = () => {
            createAccountForm.reset();
            addChargeForm.reset();
            searchAccountForm.reset();
            searchResults.innerHTML = '';
            activeAccountSection.classList.add('hidden');
            createAccountSection.classList.remove('hidden');
            searchAccountSection.classList.remove('hidden');
            displayMessage('Ready for new transaction.', 'info');
            activeAccountId = null;
            activeAccountData = null;
        };

        const createAccount = async (guestName, roomNumber) => {
            displayMessage('Creating account...', 'info');
            try {
                const res = await fetch(`${BASE_URL}/api/pos/client/account`, {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ guestName, roomNumber })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message);
                activeAccountId = data._id;
                activeAccountData = data;
                updateActiveAccountUI(data);
                displayMessage(`Account created for ${data.guestName}!`, 'success');
            } catch (err) {
                displayMessage(err.message, 'error');
            }
        };

        const addCharge = async (description, amount) => {
            if (!activeAccountId) return displayMessage('Select or create account first.', 'error');
            displayMessage('Adding charge...', 'info');
            try {
                const res = await fetch(`${BASE_URL}/api/pos/client/account/${activeAccountId}/charge`, {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ description, amount: parseFloat(amount) })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message);
                activeAccountData = data;
                updateActiveAccountUI(data);
                addChargeForm.reset();
                displayMessage('Charge added!', 'success');
            } catch (err) {
                displayMessage(err.message, 'error');
            }
        };

        const settleAccount = async (method) => {
            if (!activeAccountId) return displayMessage('No active account to settle.', 'error');
            displayMessage('Settling account...', 'info');
            let payload = method === 'room' ? { roomPost: true } : { paymentMethod: 'Cash' };
            try {
                const res = await fetch(`${BASE_URL}/api/pos/client/account/${activeAccountId}/settle`, {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                if (!res.ok) throw new Error(result.message);
                if (method === 'receipt') {
                    const receiptHtml = generateReceiptHtml(activeAccountData);
                    const printWindow = window.open('', '', 'width=400,height=600');
                    printWindow.document.write(receiptHtml);
                    printWindow.document.close();
                    printWindow.onload = () => {
                        printWindow.print();
                        setTimeout(() => printWindow.close(), 500);
                    };
                }
                displayMessage(`Account settled! Total: $${activeAccountData.totalCharges.toFixed(2)}`, 'success');
                setTimeout(resetUI, 3000);
            } catch (err) {
                displayMessage(err.message, 'error');
            }
        };

        const searchAccounts = async (query) => {
            displayMessage('Searching...', 'info');
            try {
                const res = await fetch(`${BASE_URL}/api/pos/client/search?query=${encodeURIComponent(query)}`);
                const data = await res.json();
                if (!res.ok) throw new Error(data.message);
                return data;
            } catch (err) {
                displayMessage(err.message, 'error');
                return [];
            }
        };

        const displaySearchResults = (accounts) => {
            searchResults.innerHTML = accounts.length ? '' : '<p class="text-gray-500 text-center">No accounts found.</p>';
            accounts.forEach(acc => {
                const el = document.createElement('div');
                el.className = 'p-4 border rounded-xl cursor-pointer hover:bg-gray-50';
                el.innerHTML = `<p class="font-semibold">${acc.guestName}</p>
                                <p class="text-sm">Room: ${acc.roomNumber || 'Walk-In Guest'}</p>
                                <p class="text-sm">Charges: $${acc.totalCharges.toFixed(2)}</p>`;
                el.onclick = () => {
                    activeAccountId = acc._id;
                    activeAccountData = acc;
                    updateActiveAccountUI(acc);
                    displayMessage(`Loaded account for ${acc.guestName}`, 'success');
                };
                searchResults.appendChild(el);
            });
        };

        // Event Listeners
        createAccountForm.onsubmit = e => {
            e.preventDefault();
            createAccount(new FormData(createAccountForm).get('guestName'),
                          new FormData(createAccountForm).get('roomNumber') || null);
        };
        addChargeForm.onsubmit = e => {
            e.preventDefault();
            addCharge(new FormData(addChargeForm).get('description'),
                      new FormData(addChargeForm).get('amount'));
        };
        postToRoomBtn.onclick = () => settleAccount('room');
        issueReceiptBtn.onclick = () => settleAccount('receipt');
        searchAccountForm.onsubmit = async e => {
            e.preventDefault();
            const q = document.getElementById('searchQuery').value.trim();
            if (q) displaySearchResults(await searchAccounts(q));
        };

        resetUI();
    });


        // Add these new constants at the top of your script
const dailyReportForm = document.getElementById('dailyReportForm');
const reportDateInput = document.getElementById('reportDate');
const reportResults = document.getElementById('reportResults');
const reportDateDisplay = document.getElementById('reportDateDisplay');
const reportTotalRevenue = document.getElementById('reportTotalRevenue');
const reportTableBody = document.getElementById('reportTableBody');
const exportReportBtn = document.getElementById('exportReportBtn');

// Function to generate and display the daily report
const generateDailyReport = async (date) => {
    displayMessage('Generating report...', 'info');
    reportResults.classList.add('hidden');
    try {
        const res = await fetch(`${BASE_URL}/api/pos/reports/daily?date=${date}`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Error generating report.');

        displayMessage(`Report for ${data.date} loaded.`, 'success');
        reportDateDisplay.textContent = data.date;
        reportTotalRevenue.textContent = data.totalRevenue.toFixed(2);
        
        // Clear existing table rows
        reportTableBody.innerHTML = '';

        if (data.transactions.length === 0) {
            reportTableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">No transactions found for this date.</td></tr>';
            exportReportBtn.disabled = true;
        } else {
            data.transactions.forEach(t => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-100';
                row.innerHTML = `
                    <td class="py-3 px-6 text-left whitespace-nowrap">${t.guestName} <span class="text-xs text-gray-500">(${t.roomNumber})</span></td>
                    <td class="py-3 px-6 text-left">${t.description}</td>
                    <td class="py-3 px-6 text-center">${t.source}</td>
                    <td class="py-3 px-6 text-right">$${t.amount.toFixed(2)}</td>
                `;
                reportTableBody.appendChild(row);
            });
            exportReportBtn.disabled = false;
        }
        
        reportResults.classList.remove('hidden');
    } catch (err) {
        displayMessage(err.message, 'error');
        reportResults.classList.add('hidden');
        reportTableBody.innerHTML = '';
    }
};

// Function to export table data to a CSV file (which Excel can open)
const exportToExcel = (tableId, filename) => {
    const table = document.getElementById(tableId);
    const rows = table.querySelectorAll('tr');
    let csv = [];
    
    for (let i = 0; i < rows.length; i++) {
        const row = [], cols = rows[i].querySelectorAll('td, th');
        
        for (let j = 0; j < cols.length; j++) {
            // Clean up text for CSV export
            let data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, '').replace(/(\s\s)/gm, ' ');
            data = data.replace(/"/g, '""'); // Escape double quotes
            row.push(`"${data}"`);
        }
        csv.push(row.join(','));
    }

    const csvString = csv.join('\n');
    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
};

// Add new event listeners
dailyReportForm.onsubmit = async (e) => {
    e.preventDefault();
    const selectedDate = reportDateInput.value;
    if (selectedDate) {
        await generateDailyReport(selectedDate);
    } else {
        displayMessage('Please select a date.', 'error');
    }
};

exportReportBtn.onclick = () => {
    const date = reportDateDisplay.textContent;
    exportToExcel('reportTableBody', `POS_Daily_Report_${date}.csv`);
};
        

        
    </script>
</body>
</html>
